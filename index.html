<!DOCTYPE html>
<html lang="ml">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Private Voice Caller</title>
 <link rel="manifest" href="manifest.json">
 <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
 <style>
  :root { --primary: #1a73e8; --danger: #ea4335; --success: #34a853; --gray: #5f6368; }
  body { font-family: 'Roboto', Arial, sans-serif; background-color: #ffffff; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
  .app-container { width: 100%; max-width: 450px; height: 100vh; display: flex; flex-direction: column; background: #fff; position: relative; }
  .login-screen { padding: 40px 20px; text-align: center; }
  .login-screen h2 { color: var(--primary); font-size: 24px; margin-bottom: 30px; }
  .call-screen { display: none; flex-direction: column; height: 100%; justify-content: space-between; padding: 50px 20px; text-align: center; background: #f8f9fa; z-index: 100; position: absolute; top:0; left:0; right:0; bottom:0; }
  .caller-info { margin-top: 50px; }
  .caller-avatar { width: 100px; height: 100px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 20px; }
  .remote-id-text { font-size: 28px; font-weight: 500; color: #202124; }
  .status-text { color: var(--gray); margin-top: 10px; font-size: 16px; }
  .controls { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 50px; }
  .control-btn { border: none; background: #e8eaed; width: 65px; height: 65px; border-radius: 50%; margin: 0 auto; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
  .control-btn.active { background: #202124; color: white; }
  .control-btn svg { width: 24px; height: 24px; }
  .hangup-btn { background: var(--danger); width: 75px; height: 75px; border-radius: 50%; border: none; cursor: pointer; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
  input { width: 100%; padding: 15px; border: 1px solid #dadce0; border-radius: 8px; font-size: 16px; margin-bottom: 15px; box-sizing: border-box; }
  .main-btn { background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; }
  .my-id-tag { position: absolute; top: 15px; left: 15px; font-size: 12px; color: var(--gray); background: #eee; padding: 5px 10px; border-radius: 20px; }
 </style>
</head>
<body>

<div class="app-container">
 <div id="setup-section" class="login-screen">
  <h2>Voice Caller</h2>
  <input type="text" id="custom-id-input" placeholder="‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï">
  <button class="main-btn" onclick="setCustomID()">‡¥§‡µÅ‡¥ü‡¥ô‡µç‡¥ô‡µÅ‡¥ï (Login)</button>
 </div>

 <div id="dial-section" class="login-screen" style="display:none;">
  <span class="my-id-tag">‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ID: <span id="my-id-display">...</span></span>
  <h2 style="margin-top:40px;">Call Anyone</h2>
  <input type="text" id="remote-id-input" placeholder="‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µá‡¥£‡µç‡¥ü‡¥Ø‡¥æ‡¥≥‡µÅ‡¥ü‡µÜ ID">
  <button class="main-btn" onclick="makeCall()">‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï (Call)</button>
  <button onclick="logout()" style="background:none; border:none; color:red; margin-top:20px; cursor:pointer; text-decoration:underline;">Logout</button>
 </div>

 <div id="call-screen" class="call-screen">
  <div class="caller-info">
   <div class="caller-avatar">üë§</div>
   <div id="display-remote-id" class="remote-id-text">Calling...</div>
   <div id="status-display" class="status-text">Connecting...</div>
  </div>

  <div>
   <div class="controls">
    <div>
     <button id="btn-speaker" class="control-btn" onclick="toggleSpeaker()">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.03,19.86 21,16.28 21,12C21,7.72 18.03,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16.03C15.5,15.29 16.5,13.77 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/></svg>
     </button>
     <div style="font-size:12px; margin-top:5px;">Speaker</div>
    </div>
    <div>
     <button class="control-btn" id="btn-mute" onclick="toggleMute()">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,14A3,3 0 0,0 15,11V5A3,3 0 0,0 12,2A3,3 0 0,0 9,5V11A3,3 0 0,0 12,14M17.3,11C17.3,14 14.76,16.1 12,16.1C9.24,16.1 6.7,14 6.7,11H5C5,14.41 7.72,17.23 11,17.72V21H13V17.72C16.28,17.23 19,14.41 19,11H17.3Z"/></svg>
     </button>
     <div style="font-size:12px; margin-top:5px;">Mute</div>
    </div>
    <div>
     <button class="control-btn" onclick="location.reload()">
      <svg viewBox="0 0 24 24"><path fill="currentColor" d="M12,18A6,6 0 1,0 6,12A6,6 0 0,0 12,18M12,2A10,10 0 1,1 2,12A10,10 0 0,1 12,2Z"/></svg>
     </button>
     <div style="font-size:12px; margin-top:5px;">Keypad</div>
    </div>
   </div>

   <button class="hangup-btn" onclick="hangUp()">
    <svg viewBox="0 0 24 24" width="35" height="35"><path fill="white" d="M12,9C10.28,9 8.63,9.28 7.09,9.81V12.89C7.09,13.29 6.86,13.63 6.5,13.77C5.37,14.34 4.34,15.07 3.44,15.96C3.26,16.13 3.01,16.25 2.76,16.25C2.5,16.25 2.26,16.13 2.07,15.96L0.28,14.17C0.11,13.97 0,13.72 0,13.44C0,13.17 0.11,12.92 0.28,12.72C3.25,9.89 7.42,8.12 12,8.12C16.57,8.12 20.74,9.89 23.71,12.72C23.88,12.92 24,13.17 24,13.44C24,13.72 23.88,13.97 23.71,14.17L21.92,15.96C21.73,16.13 21.49,16.25 21.23,16.25C20.98,16.25 20.73,16.13 20.55,15.96C19.65,15.07 18.61,14.34 17.47,13.77C17.11,13.63 16.88,13.29 16.88,12.89V9.81C15.36,9.28 13.71,9 12,9Z"/></svg>
   </button>
  </div>
 </div>
</div>

<audio id="remote-audio" autoplay></audio>
<audio id="ringtone" src="https://www.soundjay.com/phone/telephone-ring-03a.mp3" loop></audio>

<script>
 let peer = null;
 let currentCall = null;
 let isSpeakerOn = false;
 let localStream = null;

 if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
 }

 window.onload = () => {
  const savedId = localStorage.getItem('caller_id_v2');
  if (savedId) {
   document.getElementById('custom-id-input').value = savedId;
   setCustomID();
  }
 };

 function setCustomID() {
  const id = document.getElementById('custom-id-input').value.trim();
  if (!id) return alert("ID ‡¥®‡µΩ‡¥ï‡µÅ‡¥ï!");

  localStorage.setItem('caller_id_v2', id);
  peer = new Peer(id, {
   config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }, { url: 'stun:stun1.l.google.com:19302' }] }
  });

  peer.on('open', (myId) => {
   document.getElementById('my-id-display').innerText = myId;
   document.getElementById('setup-section').style.display = 'none';
   document.getElementById('dial-section').style.display = 'block';
  });

  peer.on('call', (call) => {
   document.getElementById('ringtone').play();
   if (confirm(call.peer + " ‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ. ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡¥£‡µã?")) {
    document.getElementById('ringtone').pause();
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
     localStream = stream;
     call.answer(stream);
     handleCall(call);
    });
   } else {
    document.getElementById('ringtone').pause();
    call.close();
   }
  });
 }

 function makeCall() {
  const rId = document.getElementById('remote-id-input').value.trim();
  if (!rId) return alert("ID ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç!");

  document.getElementById('display-remote-id').innerText = rId;
  document.getElementById('dial-section').style.display = 'none';
  document.getElementById('call-screen').style.display = 'flex';

  navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
   localStream = stream;
   const call = peer.call(rId, stream);
   handleCall(call);
  }).catch(() => {
   alert("‡¥Æ‡µà‡¥ï‡µç‡¥∞‡µã‡¥´‡µã‡µ∫ ‡¥™‡µÜ‡µº‡¥Æ‡¥ø‡¥∑‡µª ‡¥µ‡µá‡¥£‡¥Ç!");
   location.reload();
  });
 }

 function handleCall(call) {
  currentCall = call;
  document.getElementById('dial-section').style.display = 'none';
  document.getElementById('call-screen').style.display = 'flex';

  call.on('stream', (remoteStream) => {
   const audio = document.getElementById('remote-audio');
   audio.srcObject = remoteStream;
   // ‡¥°‡¥ø‡¥´‡µã‡µæ‡¥ü‡µç‡¥ü‡¥æ‡¥Ø‡¥ø ‡¥∏‡µç‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µº ‡¥ì‡¥´‡µç
   if (audio.setSinkId) audio.setSinkId("");
   document.getElementById('status-display').innerText = "‡¥ï‡¥£‡¥ï‡µç‡¥±‡µç‡¥±‡¥°‡µç ‡¥Ü‡¥£‡µç";
  });

  call.on('close', () => endCall());
 }

 async function toggleSpeaker() {
  const audio = document.getElementById('remote-audio');
  isSpeakerOn = !isSpeakerOn;
  const btn = document.getElementById('btn-speaker');

  if (audio.setSinkId) {
   const devices = await navigator.mediaDevices.enumerateDevices();
   const outputs = devices.filter(d => d.kind === 'audiooutput');
   if (isSpeakerOn) {
    await audio.setSinkId(outputs[outputs.length - 1].deviceId);
    btn.classList.add('active');
   } else {
    await audio.setSinkId("");
    btn.classList.remove('active');
   }
  } else {
   alert("‡¥¨‡µç‡¥∞‡µó‡¥∏‡µº ‡¥∏‡µç‡¥™‡µÄ‡¥ï‡µç‡¥ï‡µº ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡µª ‡¥Ö‡¥®‡µÅ‡¥µ‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥ø‡¥≤‡µç‡¥≤.");
  }
 }

 function toggleMute() {
  if (localStream) {
   const enabled = localStream.getAudioTracks()[0].enabled;
   localStream.getAudioTracks()[0].enabled = !enabled;
   document.getElementById('btn-mute').classList.toggle('active');
  }
 }

 function hangUp() {
  if (currentCall) currentCall.close();
  endCall();
 }

 function endCall() {
  document.getElementById('ringtone').pause();
  document.getElementById('call-screen').style.display = 'none';
  document.getElementById('dial-section').style.display = 'block';
  document.getElementById('status-display').innerText = "Connecting...";
  if (localStream) localStream.getTracks().forEach(track => track.stop());
 }

 function logout() {
  localStorage.clear();
  location.reload();
 }
</script>
</body>
</html>