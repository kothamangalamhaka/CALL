<!DOCTYPE html>
<html lang="ml">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Private Voice Caller</title>
 <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
 <style>
  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background-color: #f4f7f6; margin: 0; }
  .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 400px; position: relative; }
  h2 { color: #333; margin-bottom: 20px; }
  input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; transition: 0.3s; }
  input:focus { border-color: #007bff; }
  button { width: 100%; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; margin-top: 10px; }
  .btn-set { background-color: #007bff; color: white; }
  .btn-call { background-color: #28a745; color: white; }
  .btn-hangup { background-color: #dc3545; color: white; display: none; }
  .btn-speaker { background-color: #6c757d; color: white; display: none; }
  .btn-logout { background-color: transparent; color: #dc3545; font-size: 12px; text-decoration: underline; margin-top: 15px; }
  #my-id-display { font-weight: bold; color: #007bff; background: #e7f3ff; padding: 8px; border-radius: 5px; display: inline-block; margin-top: 10px; }
  .status { margin-top: 20px; color: #666; font-size: 14px; font-style: italic; }
  #call-section { display: none; }
 </style>
</head>
<body>

<div class="card">
 <h2>Voice Caller</h2>

 <div id="setup-section">
  <input type="text" id="custom-id-input" placeholder="നിങ്ങളുടെ പേര് നൽകുക (e.g. shafi123)">
  <button class="btn-set" onclick="setCustomID()">ID സെറ്റ് ചെയ്യുക</button>
 </div>

 <div id="call-section">
  <p>നിങ്ങളുടെ ID: <span id="my-id-display">...</span></p>
  <hr>
  <input type="text" id="remote-id-input" placeholder="വിളിക്കേണ്ടയാളുടെ ID നൽകുക">
  <button id="btn-call" class="btn-call" onclick="makeCall()">വിളിക്കുക (Call)</button>
  <button id="btn-speaker" class="btn-speaker" onclick="toggleSpeaker()">Speaker On/Off</button>
  <button id="btn-hangup" class="btn-hangup" onclick="hangUp()">കട്ട് ചെയ്യുക (End)</button>
  <button class="btn-logout" onclick="logout()">വേറെ ID ഉപയോഗിക്കാൻ (Logout)</button>
 </div>

 <div id="status" class="status">തുടങ്ങാൻ ഒരു ID നൽകുക</div>
</div>

<audio id="remote-audio" autoplay></audio>

<script>
 let peer = null;
 let currentCall = null;
 let isSpeakerOn = false;

 const statusDisplay = document.getElementById('status');
 const setupSection = document.getElementById('setup-section');
 const callSection = document.getElementById('call-section');
 const myIdDisplay = document.getElementById('my-id-display');
 const btnCall = document.getElementById('btn-call');
 const btnHangup = document.getElementById('btn-hangup');
 const btnSpeaker = document.getElementById('btn-speaker');

 // പേജ് ലോഡ് ആകുമ്പോൾ സേവ് ചെയ്ത ID ഉണ്ടോ എന്ന് നോക്കുക
 window.onload = () => {
  const savedId = localStorage.getItem('caller_saved_id');
  if (savedId) {
   document.getElementById('custom-id-input').value = savedId;
   setCustomID(); // ഓട്ടോമാറ്റിക്കായി ലോഗിൻ ചെയ്യും
  }
 };

 // 1. Custom ID സെറ്റ് ചെയ്യുകയും ലോഗിൻ സേവ് ചെയ്യുകയും ചെയ്യുന്നു
 function setCustomID() {
  const customId = document.getElementById('custom-id-input').value.trim();
  if (!customId) {
   alert("ദയവായി ഒരു ID നൽകുക!");
   return;
  }

  // ID ലോക്കലായി സേവ് ചെയ്യുന്നു
  localStorage.setItem('caller_saved_id', customId);

  peer = new Peer(customId, {
   config: {
    'iceServers': [
     { url: 'stun:stun.l.google.com:19302' },
     { url: 'stun:stun1.l.google.com:19302' },
     { url: 'stun:stun2.l.google.com:19302' }
    ]
   }
  });

  peer.on('open', (id) => {
   myIdDisplay.innerText = id;
   setupSection.style.display = 'none';
   callSection.style.display = 'block';
   statusDisplay.innerText = "വിളിക്കാൻ തയ്യാറാണ്...";
  });

  peer.on('error', (err) => {
   if (err.type === 'unavailable-id') {
    alert("ഈ ID നിലവിൽ ഉപയോഗത്തിലാണ്. വേറെ ഒന്ന് പരീക്ഷിക്കൂ.");
    localStorage.removeItem('caller_saved_id');
    location.reload();
   } else {
    alert("Error: " + err.type);
   }
  });

  peer.on('call', (call) => {
   if (confirm("ഒരു കോൾ വരുന്നു. സ്വീകരിക്കണോ?")) {
    statusDisplay.innerText = "കോൾ കണക്ട് ആകുന്നു...";
    navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then((stream) => {
     call.answer(stream);
     handleCall(call);
    });
   }
  });
 }

 // 2. കോൾ വിളിക്കാനുള്ള ഫംഗ്ഷൻ
 function makeCall() {
  const remoteId = document.getElementById('remote-id-input').value.trim();
  if (!remoteId) {
   alert("വിളിക്കേണ്ടയാളുടെ ID നൽകുക!");
   return;
  }

  statusDisplay.innerText = "വിളിക്കുന്നു...";
  navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then((stream) => {
   const call = peer.call(remoteId, stream);
   handleCall(call);
  }).catch(err => {
   alert("മൈക്രോഫോൺ പെർമിഷൻ ആവശ്യമാണ് (HTTPS ഉപയോഗിക്കുക)!");
  });
 }

 // 3. കോൾ ഹാൻഡിൽ ചെയ്യുന്നു
 function handleCall(call) {
  currentCall = call;
  btnCall.style.display = 'none';
  btnSpeaker.style.display = 'block';
  btnHangup.style.display = 'block';

  call.on('stream', (remoteStream) => {
   const audio = document.getElementById('remote-audio');
   audio.srcObject = remoteStream;
   statusDisplay.innerText = "കോൾ നടക്കുന്നു... (Connected)";
  });

  call.on('close', () => {
   endCallUI();
  });
 }

 // 4. സ്പീക്കർ ടോഗിൾ (ശ്രദ്ധിക്കുക: ഇത് മിക്ക ബ്രൗസറുകളിലും സിസ്റ്റം സെറ്റിംഗ്സിനെ ആശ്രയിച്ചിരിക്കും)
 async function toggleSpeaker() {
  const audio = document.getElementById('remote-audio');
  if (audio.setSinkId) {
   try {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const outputs = devices.filter(d => d.kind === 'audiooutput');
    
    // ടോഗിൾ ലോജിക്
    isSpeakerOn = !isSpeakerOn;
    const deviceIndex = isSpeakerOn ? outputs.length - 1 : 0;
    
    await audio.setSinkId(outputs[deviceIndex].deviceId);
    statusDisplay.innerText = isSpeakerOn ? "Speaker ON" : "Connected (Earpiece)";
   } catch (err) {
    console.error("സ്പീക്കർ മാറ്റാൻ കഴിഞ്ഞില്ല:", err);
   }
  } else {
   alert("നിങ്ങളുടെ ബ്രൗസർ സ്പീക്കർ മാറ്റാൻ അനുവദിക്കുന്നില്ല. ഫോൺ വോളിയം ഉപയോഗിക്കുക.");
  }
 }

 function hangUp() {
  if (currentCall) currentCall.close();
  endCallUI();
 }

 function endCallUI() {
  btnCall.style.display = 'block';
  btnHangup.style.display = 'none';
  btnSpeaker.style.display = 'none';
  statusDisplay.innerText = "കോൾ അവസാനിച്ചു.";
 }

 function logout() {
  if(confirm("ലോഗൗട്ട് ചെയ്യണോ?")) {
   localStorage.removeItem('caller_saved_id');
   location.reload();
  }
 }
</script>

</body>
</html>